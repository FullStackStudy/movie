<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<!-- Kakao Maps SDK ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="headScript">
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0002645a847652028848c550afe30640&autoload=false"></script>
</th:block>


<!-- ë³¸ë¬¸ ì˜ì—­ -->
<div layout:fragment="content">
    <!-- ì§€ë„ ì˜ì—­ -->
    <div style="display: flex; justify-content: center;">
        <div id="map" style="width:100%; height:400px;"></div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ì˜ì—­ -->
    <div id="store-detail" style="max-width: 100%; margin: 30px auto; padding: 15px; border: 1px solid #ccc; border-radius: 10px; background: #f9f9f9;">
        <p style="text-align:center;">ìƒì„¸ì •ë³´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì§€ì  ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ì§€ì  ì •ë³´ ë°°ì—´
        const markerData = [
            {
                name: 'MovieFlex_ì¸ì²œì ',
                latlng: { lat: 37.456584, lng: 126.705734 },
                address: 'ì¸ì²œê´‘ì—­ì‹œ ë¯¸ì¶”í™€êµ¬ í•„ë™ë¡œ 123',
                screens: 5,
                startTime: '07:00',
                endTime : '11:30'
            },
            {
                name: 'MovieFlex_ì„±ë‚¨ì ',
                latlng: { lat: 37.419682, lng: 127.128033 },
                address: 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ íŒêµë¡œ 456',
                screens: 6,
                startTime: '09:00',
                endTime : '11:30'
            },
            {
                name: 'MovieFlex_ë…¸ëŸ‰ì§„ì ',
                latlng: { lat: 37.515247, lng: 126.942659 },
                address: 'ì„œìš¸ ë™ì‘êµ¬ ë…¸ëŸ‰ì§„ë¡œ 789',
                screens: 7,
                startTime: '08:00',
                endTime : '11:30'
            }
        ];

        document.addEventListener('DOMContentLoaded', function () {
        kakao.maps.load(function () {
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        const container = document.getElementById('map');
        const centerLatLng = new kakao.maps.LatLng(markerData[0].latlng.lat, markerData[0].latlng.lng);
        const map = new kakao.maps.Map(container, {
            center: centerLatLng,
            level: 11
        });

        let currentInfoWindow = null;

        markerData.forEach((data, index) => {
            const marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(data.latlng.lat, data.latlng.lng),
                name: data.name
            });

            const iwContent = `
                <div style="padding:10px; font-size:13px;">
                    <strong>${data.name}</strong><br>
                    <button onclick="showDetail(${index})">ìƒì„¸ì •ë³´</button>
                </div>
            `;

            const infowindow = new kakao.maps.InfoWindow({
                content: iwContent,
                removable: true
            });

            kakao.maps.event.addListener(marker, 'click', function () {

                if (currentInfoWindow) currentInfoWindow.close();
                infowindow.open(map, marker);
                currentInfoWindow = infowindow;

                map.setLevel(12);
                map.setCenter(marker.getPosition());
                setTimeout(() => {
                    map.setLevel(3);
                }, 1000);
            });
        });

            $.ajax({
                url: '/cinema/api/save-all',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(markerData.map(m => ({
                    name: m.name,
                    address: m.address,
                    screens: m.screens,
                    lat: m.latlng.lat,
                    lng: m.latlng.lng,
                    startTime: m.startTime,
                    endTime: m.endTime
                }))),
                beforeSend : function(xhr) {
                /* ë°ì´í„° ì „ì†¡í•˜ê¸° ì „ì— í—¤ë”ì— csrf ê°’ì„ ì„¤ì • */
                    xhr.setRequestHeader(header, token);
                },
                success: function () {


                },
                error: function (xhr, status, error) {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + error);
                    console.error(xhr.responseText);
                }
            });

        window.markerData = markerData;
    });
});



    function showDetail(index) {
    const info = window.markerData[index];
    const detail = document.getElementById('store-detail');
    detail.innerHTML = `
        <div class="card shadow-sm" style="border-radius: 10px;">
            <div class="card-header bg-light text-dark fw-bold" style="font-size: 1.1rem;">
                ${info.name}
            </div>
            <div class="card-body">
                <p class="card-text"><strong>ğŸ“ ì£¼ì†Œ:</strong> ${info.address}</p>
                <p class="card-text"><strong>ğŸ¬ ìƒì˜ê´€ ìˆ˜:</strong> ${info.screens}ê°œ</p>
                <p class="card-text"><strong>â° ìš´ì˜ ì‹œê°„:</strong> ${info.startTime} ~ ${info.endTime}</p>
                <button onclick="">ì‹œê°„í‘œë³´ê¸°</button>
            </div>
        </div>
    `;
}

    </script>
</div>
</html>
