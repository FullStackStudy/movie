<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://ultaq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<div layout:fragment="css">
    <style>
        .seat {
            width: 40px; height: 40px;
            margin: 5px;
            background: #ddd;
            border-radius: 5px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            display: inline-block;
        }
        .selected {
            background: green;
            color: white;
        }
        .seat-row-label {
            font-weight: bold;
            margin-right: 10px;
            display: inline-block;
            width: 20px;
        }
        .seat-row {
            margin-bottom: 10px;
        }
    </style>

</div>
<div layout:fragment="content">
<h2>좌석 선택 (임시 데이터)</h2>

<form>
    <p>영화 ID:
        <input type="text" name="movie_name" th:text="${movieTitle}"/>
    </p>
    <p>member ID:
        <span id="member_id" th:text="${member_id}"></span></p>
    </p>

    <p>선택 좌석 (임의 선택):</p>

    <div id="seatContainer">
        <!-- 좌석은 JS로 동적으로 렌더링 -->
        <input type="text" name="selectedSeats" id="selectedSeats">
    </div>

    <br><br>
    <div th:replace="~{/reserve/reservationInfo :: info(
      movieTitle=${movieTitle},
      cinema_name=${cinemaName},
      screen_name=${screenRoomName},
      movie_time=${startTime}
    )}"></div>

    <label for="payMethod">결제 수단:</label>
        <select id="payMethod" name="payMethod" required>
            <option value="">결제 수단 선택</option>
            <option value="CASH">현금</option>
            <option value="CARD">카드</option>
            <option value="POINT">포인트</option>
        </select>
    <input type="text" name="scheduleId" id="scheduleId" th:value="${scheduleId}">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>
<script th:inline="javascript">

    $(function(){
        $('#next_button').on('click',function(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var member_id =  $("#member_id").text(); //d이름
            var movie_name = $("#movie_name").text(); //d이름
            var cinema_name = $("#cinema_name").text(); //이름
            var screen_name = $("#screen_name").text();
            var movie_time = $("#movie_time").text();
            var per = $("#per").text();
            var seat_name = $("#seat_name").text();

            var price = $("#price").text();
            var pay_method = $("#pay_method").text();
             var scheduleId = $("#scheduleId").val();



            const value =document.getElementById("selectedSeats").value
            const selectedSeatArray = value.split(",").map(Number);

            const seatNameList = seat_name.split(",");

            var url = "/reservation/reserve";
            var paramData = {
                movieName : movie_name,
                cinemaName : cinema_name,
                screenName : screen_name,
                startTime : movie_time,
                per : per,
                price : price,
                payMethod : pay_method,
                scheduleId : scheduleId,
                seatId : selectedSeatArray,
                seatName: seatNameList,
                memberId : member_id

            }

            var param = JSON.stringify(paramData);

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data: param,
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                success: function(result, status){
                    alert(result);
                    location.href='/reservation/pay';
                },
                error: function(jqXHR, status, error){
                if(jqXHR.status=='401'){
                    alert(result);

                }else{
                    alert(jqXHR.responseText);
                }
            }

            });
        });
    });
    //////////////////////////임의 좌석
    const seats = [[${seats}]];
    console.log("좌석 확인:", seats);
    const seatMap = {};

    // seatMap을 row 기준으로 분류
    seats.forEach(seat => {
        if (!seatMap[seat.seatRow]) {
            seatMap[seat.seatRow] = [];
        }
        seatMap[seat.seatRow].push(seat);
    });

    const seatContainer = document.getElementById("seatContainer");
    const selectedSeatIds = new Set();

    // 좌석 행별로 좌석 렌더링
    Object.keys(seatMap).sort().forEach(row => {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("seat-row");

        const label = document.createElement("span");
        label.classList.add("seat-row-label");
        label.textContent = row;
        rowDiv.appendChild(label);

        seatMap[row].sort((a, b) => a.seatColumn - b.seatColumn).forEach(seat => {
            const div = document.createElement("div");
            const seatList = document.getElementById("seat_id");
            div.classList.add("seat");
            div.dataset.id = seat.id;
            div.textContent = row + seat.seatColumn;

            div.onclick = function () {
                const id = div.dataset.id;
                if (selectedSeatIds.has(id)) {
                    selectedSeatIds.delete(id);
                    div.classList.remove("selected");
                } else {
                    selectedSeatIds.add(id);
                    div.classList.add("selected");
                }
                document.getElementById("selectedSeats").value = Array.from(selectedSeatIds);
                // 시각적으로 표시할 좌석명 (선택된 div들에서 textContent 가져오기)
                const selectedSeatNamesArray = Array.from(document.querySelectorAll('.seat.selected'))
                    .map(el => el.textContent);

                const selectedSeatNames = selectedSeatNamesArray.join(", ");
                const number = selectedSeatNamesArray.length;
                // movie-info 에 출력
                document.getElementById('seat_name').innerText = selectedSeatNames || "-";
                document.getElementById('per').innerText = number;
                document.getElementById('price').innerText = (number* 12000);// 나중에 price 바꾸겠음

                const payMethodSelect = document.getElementById('payMethod');
                payMethodSelect.addEventListener('change', () => {
                      const payMethod = payMethodSelect.value;
                      document.getElementById('pay_method').innerText = payMethod;
                    });
                };

            rowDiv.appendChild(div);
        });

        seatContainer.appendChild(rowDiv);
    });
</script>
</div>