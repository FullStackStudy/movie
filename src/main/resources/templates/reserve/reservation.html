<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://ultaq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<div layout:fragment="css">
    <style>
        .seat {
            width: 40px; height: 40px;
            margin: 5px;
            background: #ddd;
            border-radius: 5px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            display: inline-block;
        }
        .selected {
            background: green;
            color: white;
        }
        .seat-row-label {
            font-weight: bold;
            margin-right: 10px;
            display: inline-block;
            width: 20px;
        }
        .seat-row {
            margin-bottom: 10px;
        }
        .seat.hold {
          background-color: orange;
          cursor: not-allowed;
        }

    </style>

</div>
<div layout:fragment="content">
<h2>좌석 선택 (임시 데이터)</h2>

<form>
    <p>영화 ID:
        <input type="text" name="movie_name" th:text="${movieTitle}"/>
    </p>
    <p>member ID:
        <span id="member_id" th:text="${member_id}"></span></p>
    </p>

    <p>선택 좌석 (임의 선택):</p>

    <div id="seatContainer">
        <!-- 좌석은 JS로 동적으로 렌더링 -->
        <input type="text" name="selectedSeats" id="selectedSeats">
    </div>

    <br><br>
    <label for="payMethod">결제 수단:</label>
    <select id="payMethod" name="payMethod" required>
        <option value="">결제 수단 선택</option>
        <option value="CASH">현금</option>
        <option value="CARD">카드</option>
        <option value="POINT">포인트</option>
    </select>
    <br><br>
    <div th:replace="~{/reserve/reservationInfo :: info(
          movieTitle=${movieTitle},
          cinema_name=${cinemaName},
          screen_name=${screenRoomName},
          movie_time=${startTime},
          next_button_type=${nextButtonType}
      )}"></div>

    <input type="text" name="scheduleId" id="scheduleId" th:value="${scheduleId}">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>
<script th:inline="javascript">

    $(function(){
        $('#next_button').on('click',function(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var member_id =  $("#member_id").text(); //d이름
            var movie_name = $("#movie_name").text(); //d이름
            var cinema_name = $("#cinema_name").text(); //이름
            var screen_name = $("#screen_name").text();
            var movie_time = $("#movie_time").text();
            var per = $("#per").text();
            var seat_name = $("#seat_name").text();

            var price = $("#price").text();
            var pay_method = $("#pay_method").text();
             var scheduleId = $("#scheduleId").val();



            const value =document.getElementById("selectedSeats").value
            const selectedSeatArray = value.split(",").map(Number);

            const seatNameList = seat_name.split(",");
            var url = "/reservation/reserve";
            var paramData = {
                movieName : movie_name,
                cinemaName : cinema_name,
                screenName : screen_name,
                startTime : movie_time,
                per : per,
                price : price,
                payMethod : pay_method,
                scheduleId : scheduleId,
                seatId : selectedSeatArray,
                seatName: seatNameList,
                memberId : member_id

            }

            var param = JSON.stringify(paramData);

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data: param,
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                success: function(result, status){
                    //alert(result);
                    location.href='/reservation/pay';
                },
                error: function(jqXHR, status, error){
                if(jqXHR.status=='401'){
                    alert(result);

                }else{
                    alert(jqXHR.responseText);
                }
            }

            });
        });
    });

    //////////////////////////임의 좌석
    const seats = [[${seats}]];
    console.log("좌석 확인:", seats);
    const seatMap = {};

    // seatMap을 row 기준으로 분류
    seats.forEach(seat => {
        if (!seatMap[seat.seatRow]) {
            seatMap[seat.seatRow] = [];
        }
        seatMap[seat.seatRow].push(seat);
    });

    const reservedSeatId = [[${reservedSeatList}]];
    const seatContainer = document.getElementById("seatContainer");
    const selectedSeatIds = new Set();

    // 좌석 행별로 좌석 렌더링
    Object.keys(seatMap).sort().forEach(row => {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("seat-row");

        const label = document.createElement("span");
        label.classList.add("seat-row-label");
        label.textContent = row;
        rowDiv.appendChild(label);

        seatMap[row].sort((a, b) => a.seatColumn - b.seatColumn).forEach(seat => {
            const div = document.createElement("div");
            const seatList = document.getElementById("seat_id");
            div.classList.add("seat");
            div.dataset.id = seat.id;
            div.textContent = row + seat.seatColumn;

            const isReserved = reservedSeatId.includes(seat.id);

            if(isReserved){
                div.classList.add("reserved");
                div.style.background="#aaa";
                div.style.cursor="not-allowed";
            }else{
                div.onclick = function () {
                    const id = div.dataset.id;
                    if (selectedSeatIds.has(id)) {
                        selectedSeatIds.delete(id);
                        div.classList.remove("selected");
                    } else {
                        selectedSeatIds.add(id);
                        div.classList.add("selected");
                    }

                    // 시각적으로 표시할 좌석명 (선택된 div들에서 textContent 가져오기)

                    updateSeatInfo();

                    const payMethodSelect = document.getElementById('payMethod');
                    payMethodSelect.addEventListener('change', () => {
                          const payMethod = payMethodSelect.value;
                          document.getElementById('pay_method').innerText = payMethod;
                        });
                    };
                }
                rowDiv.appendChild(div);
            });
        seatContainer.appendChild(rowDiv);
    });



    //redis에 저장된 정보 -> 저장되어있다는건 예약중이거나 ttl아직 안끝났다는 뜻 가져와서 노란색으로 처리해줌
    //페이지 가져올 때!!!! 좌석에 redis저장되어 있는거 표시하기 위해
    const holdingSeatList = [[${holdingSeatList}]];
        console.log('holdingSeatList:', holdingSeatList );
        holdingSeatList.forEach(seatId =>{
            const seatElem = document.querySelector(`[data-id="${seatId}"]`);
            console.log('seatElem:', seatElem );
            if (seatElem) {
                seatElem.classList.add("hold");
                seatElem.style.cursor = "not-allowed";
                // 필요하면 선택 불가 처리도 여기서
                seatElem.onclick = null; // 클릭 방지
            }
        });
 ///////////////////////////////////////////////////실시간 redis 들어가는거 websocket실시간반영
        const scheduleId = $("#scheduleId").val();

        //socketJS + STOMP 클라이언트 생성
        const socket = new SockJS('/ws-seat');
        const stompClient = Stomp.over(socket);

        //연결
        stompClient.connect({}, function(){
            console.log("webSocket connected");

            //구독
            stompClient.subscribe('/topic/seats/'+ scheduleId, function(message){
            //서버에서 받은 메세지 파싱
            const seatStatusMessage = JSON.parse(message.body);
            console.log('Received seatStatusMessage:', seatStatusMessage);
             console.log('seatStatusMessage.status:', seatStatusMessage.status);  // 이 부분 확인

            console.log('Keys:', Object.keys(seatStatusMessage));

            seatStatusMessage.seatId.forEach(seatId =>{
            console.log('Processing seatId:', seatId);
                const seatElem = document.querySelector(`[data-id="${seatId}"]`);
                console.log('seatId:', seatId, 'seatElem:', seatElem);
                if(!seatElem) return;

                console.log("seatStatusMessage.status:", seatStatusMessage.status);

                if (seatStatusMessage.status === "hold") {
                    seatElem.classList.add("hold");
                    seatElem.style.cursor = "not-allowed";
                    seatElem.onclick = null; // 클릭 방지

                } else if (seatStatusMessage.status === "released") {
                    seatElem.classList.remove("hold");
                    seatElem.classList.remove("selected");
                    seatElem.style.cursor = "pointer";

                    const id = seatElem.dataset.id;
                    selectedSeatIds.delete(id);

                    updateSeatInfo();

                    seatElem.onclick = function() {

                        if (selectedSeatIds.has(id)) {
                            selectedSeatIds.delete(id);
                            seatElem.classList.remove("selected");
                        } else {
                            selectedSeatIds.add(id);
                            seatElem.classList.add("selected");
                        }

                       // document.getElementById("selectedSeats").value = Array.from(selectedSeatIds);
                        updateSeatInfo();
                        };
                    }

                console.log("좌석 상태 업데이트:", seatId, seatStatusMessage.status, seatElem);
            });
            });
        });
////////////////////////////////
        function updateSeatInfo(){
            document.getElementById("selectedSeats").value = Array.from(selectedSeatIds);
            const selectedSeatNamesArray = Array.from(document.querySelectorAll('.seat.selected'))
                        .map(el => el.textContent);

            const selectedSeatNames = selectedSeatNamesArray.join(", ");
            const number = selectedSeatNamesArray.length;

            // movie-info 에 출력
            document.getElementById('seat_name').innerText = selectedSeatNames || "-";
            document.getElementById('per').innerText = number;
            document.getElementById('price').innerText = (number* 12000);// 나중에 price 바꾸겠음
        }


</script>
</div>