<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://ultaq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<div layout:fragment="css">
    <style>
        .seat {
            width: 40px; height: 40px;
            margin: 5px;
            background: #ddd;
            border-radius: 5px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            display: inline-block;
        }
        .selected {
            background: green;
            color: white;
        }
        .seat-row-label {
            font-weight: bold;
            margin-right: 10px;
            display: inline-block;
            width: 20px;
        }
        .seat-row {
            margin-bottom: 10px;
        }
    </style>

</div>
<div layout:fragment="content">
<h2>좌석 선택 (임시 데이터)</h2>

<form>
    <p>영화 ID:
        <input type="text" id="movie_id" name="movie_id" />
    </p>
    <p>member ID:
        <span id="member_id" th:text="${member_id}"></span></p>
    </p>

    <p>선택 좌석 (임의 선택):</p>

    <div id="seatContainer">
        <!-- 좌석은 JS로 동적으로 렌더링 -->
        <input type="text" name="selectedSeats" id="selectedSeats">
    </div>

    <br><br>
    <button type="button" id="reserve-btn">예약하기</button>
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>
<script th:inline="javascript">
    $(function(){
        $('#reserve-btn').on('click',function(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");


            var movie_id = $("#movie_id").val();
            var member_id = $("#member_id").text();
            const value = document.getElementById("selectedSeats").value;
            const selectedSeatArray = value.split(",");
            //var seat_id = $("#selectedSeats").val();
            //var seat_id = $('input[name="seat_id"]:checked').map(function(){
            //    return $(this).val();
            //}).get();
            var url = "/reservation/reserve";
            var paramData = {
                movie_id : movie_id,
                member_id : member_id,
                seat_id : selectedSeatArray
            }

            var param = JSON.stringify(paramData);

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data: param,
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                success: function(result, status){
                    alert(result);
                    location.href='/reservation/pay';
                },
                error: function(jqXHR, status, error){
                if(jqXHR.status=='401'){
                    alert(result);

                }else{
                    alert(jqXHR.responseText);
                }
            }

            });
        });
    });
    //////////////////////////임의 좌석
    const seats = [[${seats}]];
    console.log("좌석 확인:", seats);
    const seatMap = {};

    // seatMap을 row 기준으로 분류
    seats.forEach(seat => {
        if (!seatMap[seat.seatRow]) {
            seatMap[seat.seatRow] = [];
        }
        seatMap[seat.seatRow].push(seat);
    });

    const seatContainer = document.getElementById("seatContainer");
    const selectedSeatIds = new Set();

    // 좌석 행별로 좌석 렌더링
    Object.keys(seatMap).sort().forEach(row => {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("seat-row");

        const label = document.createElement("span");
        label.classList.add("seat-row-label");
        label.textContent = row;
        rowDiv.appendChild(label);

        seatMap[row].sort((a, b) => a.seatCol - b.seatCol).forEach(seat => {
            const div = document.createElement("div");
            div.classList.add("seat");
            div.dataset.id = seat.id;
            div.textContent = row + seat.seatCol;

            div.onclick = function () {
                const id = div.dataset.id;
                if (selectedSeatIds.has(id)) {
                    selectedSeatIds.delete(id);
                    div.classList.remove("selected");
                } else {
                    selectedSeatIds.add(id);
                    div.classList.add("selected");
                }
                document.getElementById("selectedSeats").value = Array.from(selectedSeatIds);
            };

            rowDiv.appendChild(div);
        });

        seatContainer.appendChild(rowDiv);
    });
</script>
</div>